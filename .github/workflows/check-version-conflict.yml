name: åŒæ­¥åˆ° Greasy Fork

on:
  push:
    branches:
      - main
    paths:
      - 'çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js'

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write
  releases: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å¢åŠ æ·±åº¦ä»¥è·å–å®Œæ•´çš„æäº¤å†å²

      - name: æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦æ›´æ–°
        id: check-version
        run: |
          FILE="çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js"
          echo "æ£€æŸ¥ $FILE ç‰ˆæœ¬..."

          # è·å–å½“å‰è„šæœ¬æ–‡ä»¶çš„ç‰ˆæœ¬å·
          CURRENT_VERSION=$(grep -m1 "@version" "$FILE" | sed 's/.*@version[[:space:]]*//;s/[[:space:]]*$//')
          echo "è„šæœ¬å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"

          if [ -z "$CURRENT_VERSION" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªåœ¨è„šæœ¬ä¸­æ‰¾åˆ° @version"
            exit 1
          fi

          # è·å–ä¸Šä¸€ä¸ª commit çš„ç‰ˆæœ¬å·
          PREV_VERSION=$(git show HEAD~1:"$FILE" 2>/dev/null | grep -m1 "@version" | sed 's/.*@version[[:space:]]*//;s/[[:space:]]*$//' || echo "")
          echo "ä¸Šä¸€ä¸ªç‰ˆæœ¬: $PREV_VERSION"

          # å¼ºæ ¡éªŒé€»è¾‘ï¼šå¦‚æœä½ ç›´æ¥ push åˆ° main ä½†æ²¡æ”¹ç‰ˆæœ¬å·ï¼Œç›´æ¥è®©ä»»åŠ¡å¤±è´¥
          if [ "$CURRENT_VERSION" = "$PREV_VERSION" ]; then
            echo "=========================================="
            echo "âŒ æŠ¥é”™ï¼šè„šæœ¬å†…å®¹å·²ä¿®æ”¹ï¼Œä½†ç‰ˆæœ¬å· ($CURRENT_VERSION) æœªæ›´æ–°ï¼"
            echo "è¯·ä¿®æ”¹ @version åé‡æ–°æäº¤ï¼Œå¦åˆ™ Greasy Fork ä¸ä¼šåŒæ­¥ã€‚"
            echo "=========================================="
            exit 1 
          fi

          echo "should_sync=true" >> $GITHUB_OUTPUT
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… ç‰ˆæœ¬å·²ä» $PREV_VERSION æ›´æ–°è‡³ $CURRENT_VERSION"

      - name: è§¦å‘ Greasy Fork åŒæ­¥
        if: steps.check-version.outputs.should_sync == 'true'
        run: |
          echo "ğŸš€ è§¦å‘ Greasy Fork Webhook..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d '{"ref":"refs/heads/main","repository":{"full_name":"jiangbkvir/jinianbi"}}' \
            "${{ secrets.GREASYFORK_WEBHOOK_URL }}")

          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "202" ]; then
            echo "âœ… Webhook è§¦å‘æˆåŠŸ (HTTP $RESPONSE)"
          else
            echo "âŒ Webhook å¤±è´¥ (HTTP $RESPONSE)"
            exit 1
          fi

      - name: ç”Ÿæˆ Release Notes
        if: steps.check-version.outputs.should_sync == 'true'
        run: |
          VERSION="${{ steps.check-version.outputs.version }}"
          # è·å–æœ€åä¸€æ¡æäº¤ä¿¡æ¯ä½œä¸ºæ›´æ–°å†…å®¹
          COMMIT_LOG=$(git log -1 --pretty=format:"- %s")

          # ä¿®å¤ 101 è¡ŒæŠ¥é”™ï¼šç§»é™¤ EOF çš„å•å¼•å·ï¼Œå¹¶ä½¿ç”¨æ ‡å‡†çš„ shell å˜é‡è§£æ
          cat <<EOF > release-notes.md
## Release v${VERSION}

### ğŸ“ æ›´æ–°å†…å®¹
${COMMIT_LOG}

### ğŸ“¦ å®‰è£…æ–¹å¼
**Greasy Fork (æ¨è):**
https://greasyfork.org/zh-CN/scripts/521357

**ç›´æ¥å®‰è£…:**
ç‚¹å‡»ä¸‹æ–¹çš„ `çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js` æ–‡ä»¶

### ğŸ”— ç›¸å…³é“¾æ¥
- [ä½¿ç”¨æ–‡æ¡£](https://github.com/jiangbkvir/jinianbi/blob/main/README.md)
- [é—®é¢˜åé¦ˆ](https://github.com/jiangbkvir/jinianbi/issues)

---
è‡ªåŠ¨åŒæ­¥åˆ° Greasy Fork
EOF

      - name: åˆ›å»º GitHub Release
        if: steps.check-version.outputs.should_sync == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.check-version.outputs.version }}
          name: Release v${{ steps.check-version.outputs.version }}
          body_path: release-notes.md
          files: çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
