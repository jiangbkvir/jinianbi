name: æŒç»­é›†æˆ / Greasy Fork åŒæ­¥ / Pages éƒ¨ç½²

on:
  push:
    branches:
      - main
    paths:
      - 'çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  greasyfork:
    name: åŒæ­¥ Greasy Fork å¹¶å‘å¸ƒ Release
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ£€æµ‹è„šæœ¬æ˜¯å¦å‘ç”Ÿå˜åŒ–åŠç‰ˆæœ¬å·
        id: check
        run: |
          FILE="çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js"
          if git diff --name-only HEAD~1 HEAD | grep -q "$FILE"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ”¹ è„šæœ¬æœ‰ä¿®æ”¹"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "ğŸ”¹ è„šæœ¬æœªä¿®æ”¹"
          fi

          if [ "$(git diff --name-only HEAD~1 HEAD | grep -q "$FILE"; echo $?)" -eq 0 ]; then
            CUR=$(grep -m1 "@version" "$FILE" | sed 's/.*@version[[:space:]]*//')
            PRE=$(git show HEAD~1:"$FILE" 2>/dev/null | grep -m1 "@version" | sed 's/.*@version[[:space:]]*//' || echo "")
            if [ -z "$CUR" ]; then
              echo "âŒ æœªæ‰¾åˆ° @version"
              exit 1
            fi
            if [ "$CUR" = "$PRE" ]; then
              echo "âš ï¸ è„šæœ¬ä¿®æ”¹äº†ä½†ç‰ˆæœ¬å·æœªæ›´æ–°ï¼Œä¸æ‰§è¡Œå‘å¸ƒ"
              echo "update=false" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âœ… ç‰ˆæœ¬å·æ›´æ–°ï¼Œå‡†å¤‡å‘å¸ƒ v$CUR"
              echo "version=$CUR" >> $GITHUB_OUTPUT
              echo "update=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "è„šæœ¬æœªä¿®æ”¹ï¼Œæ— éœ€å‘å¸ƒ"
            echo "update=false" >> $GITHUB_OUTPUT
          fi

      - name: è§¦å‘ Greasy Fork åŒæ­¥
        if: steps.check.outputs.update == 'true'
        run: |
          echo "ğŸ”¹ åŒæ­¥åˆ° Greasy Fork..."
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{"ref":"refs/heads/main","repository":{"full_name":"jiangbkvir/jinianbi"}}' \
            "${{ secrets.GREASYFORK_WEBHOOK_URL }}"
          echo "âœ… Greasy Fork åŒæ­¥å®Œæˆ"

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜ï¼ˆRelease Notesï¼‰
        if: steps.check.outputs.update == 'true'
        run: |
          VERSION=${{ steps.check.outputs.version }}
          echo "## Release v$VERSION" > release-notes.md
          echo "" >> release-notes.md
          echo "### æ›´æ–°å†…å®¹" >> release-notes.md
          git log -1 --pretty=format:"- %s" >> release-notes.md
          echo "" >> release-notes.md
          echo "---" >> release-notes.md
          echo "è‡ªåŠ¨åŒæ­¥åˆ° Greasy Fork" >> release-notes.md
          echo "ğŸ”¹ Release Notes ç”Ÿæˆå®Œæˆ"

      - name: åˆ›å»º GitHub Release
        if: steps.check.outputs.update == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.check.outputs.version }}
          name: Release v${{ steps.check.outputs.version }}
          body_path: release-notes.md
          files: çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è¾“å‡º Release æˆåŠŸä¿¡æ¯
        if: steps.check.outputs.update == 'true'
        run: |
          echo "âœ… GitHub Release å·²åˆ›å»ºï¼Œç‰ˆæœ¬å· v${{ steps.check.outputs.version }}"
