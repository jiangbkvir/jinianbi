name: æŒç»­é›†æˆ / Greasy Fork åŒæ­¥ / Pages éƒ¨ç½²

on:
  push:
    branches:
      - main
    paths:
      - "script.user.js"
      - "docs/**"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  greasyfork:
    name: åŒæ­¥ Greasy Fork å¹¶å‘å¸ƒ Release
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ ¡éªŒè„šæœ¬ç‰ˆæœ¬å·
        id: check
        run: |
          FILE="script.user.js"

          # Because of the 'on.push.paths' trigger, this workflow only runs
          # when the script has changed. We just need to check the version.
          echo "ğŸ”¹ è„šæœ¬æœ‰ä¿®æ”¹ï¼Œå¼€å§‹æ ¡éªŒç‰ˆæœ¬å·..."

          CUR=$(grep -m1 "@version" "$FILE" | sed 's/.*@version[[:space:]]*//')

          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # This is a new branch, so there is no previous version.
            PRE=""
          else
            # Get the version from the commit before the push.
            PRE=$(git show ${{ github.event.before }}:"$FILE" 2>/dev/null | grep -m1 "@version" | sed 's/.*@version[[:space:]]*//' || echo "")
          fi

          if [ -z "$CUR" ]; then
            echo "âŒ æœªæ‰¾åˆ° @version å­—æ®µ"
            exit 1
          fi

          if [ "$CUR" = "$PRE" ]; then
            echo "âš ï¸ è„šæœ¬å·²ä¿®æ”¹ä½†ç‰ˆæœ¬å· (v$CUR) æœªæ›´æ–°ï¼Œè·³è¿‡å‘å¸ƒã€‚"
            echo "update=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… ç‰ˆæœ¬å·å·²æ›´æ–°: v$PRE -> v$CURã€‚å‡†å¤‡å‘å¸ƒã€‚"
            echo "version=$CUR" >> $GITHUB_OUTPUT
            echo "update=true" >> $GITHUB_OUTPUT
          fi

      - name: åˆ›å»º GitHub Release
        if: steps.check.outputs.update == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.check.outputs.version }}
          name: Release v${{ steps.check.outputs.version }}
          body_path: release.md
          files: script.user.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è¾“å‡º Release æˆåŠŸä¿¡æ¯
        if: steps.check.outputs.update == 'true'
        run: |
          echo "âœ… GitHub Release å·²åˆ›å»ºï¼Œç‰ˆæœ¬å· v${{ steps.check.outputs.version }}"

      - name: æ›´æ–° README.md ç‰ˆæœ¬å¾½ç« 
        if: steps.check.outputs.update == 'true'
        run: |
          VERSION=${{ steps.check.outputs.version }}
          sed -i -E "s/(version-)[0-9]+\.[0-9]+\.[0-9]+(-blue\.svg)/\1$VERSION\2/" README.md
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Docs: Update version badge in README.md to v$VERSION" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  pages:
    name: éƒ¨ç½² GitHub Pages
    runs-on: ubuntu-latest
    # ä»…åœ¨ docs ç›®å½•å˜æ›´æˆ–æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œ
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'push' && contains(join(github.event.commits.*.modified, ''), 'docs/'))

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: é…ç½® Pages
        uses: actions/configure-pages@v4

      - name: ä¸Šä¼  Pages äº§ç‰©
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./docs"

      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
