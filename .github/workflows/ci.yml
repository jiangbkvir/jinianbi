name: æŒç»­é›†æˆ / Greasy Fork åŒæ­¥ / Pages éƒ¨ç½²

on:
  push:
    branches:
      - main
    paths:
      - 'çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  greasyfork:
    name: åŒæ­¥ Greasy Fork å¹¶å‘å¸ƒ Release
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ ¡éªŒè„šæœ¬ç‰ˆæœ¬å·
        id: check
        run: |
          FILE="çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js"
          
          # Because of the 'on.push.paths' trigger, this workflow only runs
          # when the script has changed. We just need to check the version.
          echo "ğŸ”¹ è„šæœ¬æœ‰ä¿®æ”¹ï¼Œå¼€å§‹æ ¡éªŒç‰ˆæœ¬å·..."

          CUR=$(grep -m1 "@version" "$FILE" | sed 's/.*@version[[:space:]]*//')
          
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # This is a new branch, so there is no previous version.
            PRE=""
          else
            # Get the version from the commit before the push.
            PRE=$(git show ${{ github.event.before }}:"$FILE" 2>/dev/null | grep -m1 "@version" | sed 's/.*@version[[:space:]]*//' || echo "")
          fi

          if [ -z "$CUR" ]; then
            echo "âŒ æœªæ‰¾åˆ° @version å­—æ®µ"
            exit 1
          fi

          if [ "$CUR" = "$PRE" ]; then
            echo "âš ï¸ è„šæœ¬å·²ä¿®æ”¹ä½†ç‰ˆæœ¬å· (v$CUR) æœªæ›´æ–°ï¼Œè·³è¿‡å‘å¸ƒã€‚"
            echo "update=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… ç‰ˆæœ¬å·å·²æ›´æ–°: v$PRE -> v$CURã€‚å‡†å¤‡å‘å¸ƒã€‚"
            echo "version=$CUR" >> $GITHUB_OUTPUT
            echo "update=true" >> $GITHUB_OUTPUT
          fi

      - name: è§¦å‘ Greasy Fork åŒæ­¥
        if: steps.check.outputs.update == 'true'
        run: |
          echo "ğŸ”¹ åŒæ­¥åˆ° Greasy Fork..."
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{"ref":"refs/heads/main","repository":{"full_name":"jiangbkvir/jinianbi"}}' \
            "${{ secrets.GREASYFORK_WEBHOOK_URL }}"
          echo "âœ… Greasy Fork åŒæ­¥å®Œæˆ"

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜ï¼ˆRelease Notesï¼‰
        if: steps.check.outputs.update == 'true'
        run: |
          VERSION=${{ steps.check.outputs.version }}
          echo "## Release v$VERSION" > release-notes.md
          echo "" >> release-notes.md
          echo "### æ›´æ–°å†…å®¹" >> release-notes.md
          git log -1 --pretty=format:"- %s" >> release-notes.md
          echo "" >> release-notes.md
          echo "---" >> release-notes.md
          echo "è‡ªåŠ¨åŒæ­¥åˆ° Greasy Fork" >> release-notes.md
          echo "ğŸ”¹ Release Notes ç”Ÿæˆå®Œæˆ"

      - name: åˆ›å»º GitHub Release
        if: steps.check.outputs.update == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.check.outputs.version }}
          name: Release v${{ steps.check.outputs.version }}
          body_path: release-notes.md
          files: çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è¾“å‡º Release æˆåŠŸä¿¡æ¯
        if: steps.check.outputs.update == 'true'
        run: |
          echo "âœ… GitHub Release å·²åˆ›å»ºï¼Œç‰ˆæœ¬å· v${{ steps.check.outputs.version }}"
