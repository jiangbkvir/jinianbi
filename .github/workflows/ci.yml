name: æŒç»­é›†æˆ / Greasy Fork åŒæ­¥ / Pages éƒ¨ç½²

on:
  push:
    branches:
      - main
    paths:
      - 'çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  greasyfork:
    name: åŒæ­¥ Greasy Fork å¹¶å‘å¸ƒ Release
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ ¡éªŒè„šæœ¬ç‰ˆæœ¬å· (ISOLATION TEST)
        id: check
        run: |
          echo "This is a test. Hardcoding update=false"
          echo "update=false" >> $GITHUB_OUTPUT

      - name: è§¦å‘ Greasy Fork åŒæ­¥
        if: steps.check.outputs.update == 'true'
        run: |
          echo "ğŸ”¹ åŒæ­¥åˆ° Greasy Fork..."
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{"ref":"refs/heads/main","repository":{"full_name":"jiangbkvir/jinianbi"}}' \
            "${{ secrets.GREASYFORK_WEBHOOK_URL }}"
          echo "âœ… Greasy Fork åŒæ­¥å®Œæˆ"

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜ï¼ˆRelease Notesï¼‰
        if: steps.check.outputs.update == 'true'
        run: |
          VERSION=${{ steps.check.outputs.version }}
          echo "## Release v$VERSION" > release-notes.md
          echo "" >> release-notes.md
          echo "### æ›´æ–°å†…å®¹" >> release-notes.md
          git log -1 --pretty=format:"- %s" >> release-notes.md
          echo "" >> release-notes.md
          echo "---" >> release-notes.md
          echo "è‡ªåŠ¨åŒæ­¥åˆ° Greasy Fork" >> release-notes.md
          echo "ğŸ”¹ Release Notes ç”Ÿæˆå®Œæˆ"

      - name: åˆ›å»º GitHub Release
        if: steps.check.outputs.update == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.check.outputs.version }}
          name: Release v${{ steps.check.outputs.version }}
          body_path: release-notes.md
          files: çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è¾“å‡º Release æˆåŠŸä¿¡æ¯
        if: steps.check.outputs.update == 'true'
        run: |
          echo "âœ… GitHub Release å·²åˆ›å»ºï¼Œç‰ˆæœ¬å· v${{ steps.check.outputs.version }}"
