name: å‘å¸ƒä¸éƒ¨ç½²

on:
  push:
    branches:
      - main
    paths:
      - 'çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  releases: write

jobs:
  # ä»»åŠ¡ä¸€ï¼šæ£€æŸ¥ç‰ˆæœ¬å¹¶åŒæ­¥åˆ° Greasy Fork
  sync-and-release:
    # ä»…å½“ userscript æ–‡ä»¶å˜åŒ–æ—¶è¿è¡Œ
    if: "contains(github.event.head_commit.modified, 'çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js') || github.event_name == 'workflow_dispatch'"
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # è·å–æœ€è¿‘ä¸¤æ¬¡æäº¤è®°å½•ç”¨äºå¯¹æ¯”

      - name: æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦æ›´æ–°
        id: check-version
        run: |
          FILE="çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js"
          echo "æ£€æŸ¥ $FILE ç‰ˆæœ¬..."

          CURRENT_VERSION=$(grep -m1 "@version" "$FILE" | sed 's/.*@version[[:space:]]*//;s/[[:space:]]*$//')
          echo "è„šæœ¬å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"

          if [ -z "$CURRENT_VERSION" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªåœ¨è„šæœ¬ä¸­æ‰¾åˆ° @version"
            exit 1
          fi

          # è·å–ä¸Šä¸€ä¸ª commit çš„ç‰ˆæœ¬å·
          PREV_VERSION=$(git show HEAD~1:"$FILE" 2>/dev/null | grep -m1 "@version" | sed 's/.*@version[[:space:]]*//;s/[[:space:]]*$//' || echo "")
          echo "ä¸Šä¸€ä¸ªç‰ˆæœ¬: $PREV_VERSION"

          # å¼ºæ ¡éªŒé€»è¾‘ï¼šå¦‚æœæ–‡ä»¶ä¿®æ”¹ä½†ç‰ˆæœ¬å·æœªå˜ï¼Œåˆ™å¤±è´¥
          if [ "$CURRENT_VERSION" = "$PREV_VERSION" ]; then
            echo "=========================================="
            echo "âŒ æŠ¥é”™ï¼šè„šæœ¬å†…å®¹å·²ä¿®æ”¹ï¼Œä½†ç‰ˆæœ¬å· ($CURRENT_VERSION) æœªæ›´æ–°ï¼"
            echo "è¯·ä¿®æ”¹ @version åé‡æ–°æäº¤ï¼Œå¦åˆ™ Greasy Fork ä¸ä¼šåŒæ­¥ã€‚"
            echo "=========================================="
            exit 1
          fi
          
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… ç‰ˆæœ¬å·²ä» $PREV_VERSION æ›´æ–°è‡³ $CURRENT_VERSION"

      - name: è§¦å‘ Greasy Fork åŒæ­¥
        run: |
          echo "ğŸš€ è§¦å‘ Greasy Fork Webhook..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d '{"ref":"refs/heads/main","repository":{"full_name":"jiangbkvir/jinianbi"}}' \
            "${{ secrets.GREASYFORK_WEBHOOK_URL }}")

          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "202" ]; then
            echo "âœ… Webhook è§¦å‘æˆåŠŸ (HTTP $RESPONSE)"
          else
            echo "âŒ Webhook å¤±è´¥ (HTTP $RESPONSE)"
            # æš‚æ—¶ä¸å¼ºåˆ¶å¤±è´¥ï¼Œåªåšè­¦å‘Š
            # exit 1 
          fi

      - name: ç”Ÿæˆ Release Notes
        id: generate-notes
        # ç®€åŒ–ç”Ÿæˆ Release Notes çš„é€»è¾‘ï¼Œé¿å… YAML è§£æé—®é¢˜
        run: |
          VERSION="${{ steps.check-version.outputs.version }}"
          COMMIT_LOG=$(git log -1 --pretty=format:"- %s")
          echo "## Release v${VERSION}" > release-notes.md
          echo "" >> release-notes.md
          echo "### ğŸ“ æ›´æ–°å†…å®¹" >> release-notes.md
          echo "${COMMIT_LOG}" >> release-notes.md
          echo "" >> release-notes.md
          echo "### ğŸ“¦ å®‰è£…æ–¹å¼" >> release-notes.md
          echo "**Greasy Fork (æ¨è):**" >> release-notes.md
          echo "https://greasyfork.org/zh-CN/scripts/521357" >> release-notes.md
          echo "" >> release-notes.md
          echo "**ç›´æ¥å®‰è£…:**" >> release-notes.md
          echo "ç‚¹å‡»ä¸‹æ–¹çš„ \`çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js\` æ–‡ä»¶" >> release-notes.md
          echo "" >> release-notes.md
          echo "### ğŸ”— ç›¸å…³é“¾æ¥" >> release-notes.md
          echo "- [ä½¿ç”¨æ–‡æ¡£](https://github.com/jiangbkvir/jinianbi/blob/main/README.md)" >> release-notes.md
          echo "- [é—®é¢˜åé¦ˆ](https://github.com/jiangbkvir/jinianbi/issues)" >> release-notes.md
          echo "" >> release-notes.md
          echo "---" >> release-notes.md
          echo "è‡ªåŠ¨åŒæ­¥åˆ° Greasy Fork" >> release-notes.md

          ls -l release-notes.md
          cat release-notes.md

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.check-version.outputs.version }}
          name: Release v${{ steps.check-version.outputs.version }}
          body_path: release-notes.md
          files: çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ä»»åŠ¡äºŒï¼šéƒ¨ç½²åˆ° GitHub Pages
  deploy-pages:
    # ä»…å½“ docs ç›®å½•å˜åŒ–æ—¶è¿è¡Œ
    if: "contains(github.event.head_commit.modified, 'docs/') || github.event_name == 'workflow_dispatch'"
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'

      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
