name: åŒæ­¥åˆ° Greasy Fork

on:
  push:
    branches:
      - main
    paths:
      - 'çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js'

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦æ›´æ–°
        id: check-version
        run: |
          echo "æ£€æŸ¥çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js ç‰ˆæœ¬å˜åŒ–..."

          # è·å–å½“å‰ç‰ˆæœ¬å·
          CURRENT_VERSION=$(grep -m1 "@version" çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js | sed 's/.*@version[[:space:]]*//;s/[[:space:]]*$//')
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"

          # è·å–ä¸Šä¸€ä¸ªæäº¤çš„ç‰ˆæœ¬å·
          PREV_VERSION=$(git show HEAD^:çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js 2>/dev/null | grep -m1 "@version" | sed 's/.*@version[[:space:]]*//;s/[[:space:]]*$//' || echo "")
          echo "ä¸Šä¸€ä¸ªç‰ˆæœ¬: $PREV_VERSION"

          if [ "$CURRENT_VERSION" != "$PREV_VERSION" ] && [ -n "$CURRENT_VERSION" ]; then
            echo "should_sync=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "âœ… ç‰ˆæœ¬å·å·²æ›´æ–°: $PREV_VERSION â†’ $CURRENT_VERSIONï¼Œå°†è§¦å‘åŒæ­¥"
          else
            echo "should_sync=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ ç‰ˆæœ¬å·æœªå˜åŒ–ï¼Œè·³è¿‡åŒæ­¥"
          fi

      - name: è§¦å‘ Greasy Fork åŒæ­¥
        if: steps.check-version.outputs.should_sync == 'true'
        run: |
          echo "ğŸš€ è§¦å‘ Greasy Fork Webhook åŒæ­¥..."
          echo "ç‰ˆæœ¬: ${{ steps.check-version.outputs.version }}"

          # å‘é€ webhook è¯·æ±‚
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d '{"ref":"refs/heads/main","repository":{"full_name":"jiangbkvir/jinianbi"}}' \
            "${{ secrets.GREASYFORK_WEBHOOK_URL }}")

          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "202" ]; then
            echo "âœ… Webhook è§¦å‘æˆåŠŸ (HTTP $RESPONSE)"
          else
            echo "âš ï¸ Webhook å“åº”: $RESPONSE"
          fi

      - name: åŒæ­¥å¤±è´¥æç¤º
        if: steps.check-version.outputs.should_sync == 'false'
        run: |
          echo "=========================================="
          echo "â„¹ï¸ è„šæœ¬æ–‡ä»¶å·²ä¿®æ”¹ï¼Œä½†ç‰ˆæœ¬å·æœªæ›´æ–°"
          echo "å½“å‰ç‰ˆæœ¬æœªå˜åŒ–ï¼Œæœªè§¦å‘ Greasy Fork åŒæ­¥"
          echo "=========================================="
