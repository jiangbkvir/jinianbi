name: åŒæ­¥åˆ° Greasy Fork

on:
  push:
    branches:
      - main
    paths:
      - 'çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js'

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦æ›´æ–°
        id: check-version
        run: |
          echo "æ£€æŸ¥çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js ç‰ˆæœ¬å˜åŒ–..."

          # èŽ·å–å½“å‰ç‰ˆæœ¬å·
          CURRENT_VERSION=$(grep -m1 "@version" çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js | sed 's/.*@version[[:space:]]*//;s/[[:space:]]*$//')
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"

          # èŽ·å–ä¸Šä¸€ä¸ªæäº¤çš„ç‰ˆæœ¬å·ï¼ˆä½¿ç”¨ origin/main ä½œä¸ºåŸºå‡†ï¼‰
          git fetch origin main --depth=10
          PREV_VERSION=$(git show origin/main~1:çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js 2>/dev/null | grep -m1 "@version" | sed 's/.*@version[[:space:]]*//;s/[[:space:]]*$//' || echo "")
          echo "ä¸Šä¸€ä¸ªç‰ˆæœ¬: $PREV_VERSION"

          # ä¸¥æ ¼æ£€æŸ¥ï¼šç‰ˆæœ¬å·å¿…é¡»ä¸åŒä¸”éƒ½ä¸ä¸ºç©º
          if [ -n "$CURRENT_VERSION" ] && [ -n "$PREV_VERSION" ] && [ "$CURRENT_VERSION" != "$PREV_VERSION" ]; then
            echo "should_sync=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "âœ… ç‰ˆæœ¬å·å·²æ›´æ–°: $PREV_VERSION â†’ $CURRENT_VERSIONï¼Œå°†è§¦å‘åŒæ­¥"
          else
            echo "should_sync=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ ç‰ˆæœ¬å·æœªå˜åŒ–ï¼ˆå½“å‰: $CURRENT_VERSION, ä¸Šä¸€ä¸ª: $PREV_VERSIONï¼‰ï¼Œè·³è¿‡åŒæ­¥"
          fi

      - name: è§¦å‘ Greasy Fork åŒæ­¥
        if: steps.check-version.outputs.should_sync == 'true'
        run: |
          echo "ðŸš€ è§¦å‘ Greasy Fork Webhook åŒæ­¥..."
          echo "ç‰ˆæœ¬: ${{ steps.check-version.outputs.version }}"

          # å‘é€ webhook è¯·æ±‚
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d '{"ref":"refs/heads/main","repository":{"full_name":"jiangbkvir/jinianbi"}}' \
            "${{ secrets.GREASYFORK_WEBHOOK_URL }}")

          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "202" ]; then
            echo "âœ… Webhook è§¦å‘æˆåŠŸ (HTTP $RESPONSE)"
          else
            echo "âš ï¸ Webhook å“åº”: $RESPONSE"
          fi

      - name: ç”Ÿæˆ Release Notes
        if: steps.check-version.outputs.should_sync == 'true'
        id: release-notes
        run: |
          VERSION="${{ steps.check-version.outputs.version }}"

          # èŽ·å–æœ€æ–°çš„æäº¤ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=%B)

          # ç”Ÿæˆ Release Notes
          cat > release-notes.md <<EOF
          ## ðŸŽ‰ ç‰ˆæœ¬ ${VERSION}

          ### ðŸ“ æ›´æ–°å†…å®¹
          ${COMMIT_MSG}

          ### ðŸ“¦ å®‰è£…æ–¹å¼

          **Greasy Fork (æŽ¨è):**
          [https://greasyfork.org/zh-CN/scripts/521357-çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·](https://greasyfork.org/zh-CN/scripts/521357-%E7%BA%AA%E5%BF%B5%E5%B8%81%E9%A2%84%E7%BA%A6%E8%BE%85%E5%8A%A9%E5%B7%A5%E5%85%B7)

          **ç›´æŽ¥å®‰è£…:**
          ç‚¹å‡»ä¸‹æ–¹çš„ \`çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js\` æ–‡ä»¶å³å¯å®‰è£…

          ### ðŸ”— ç›¸å…³é“¾æŽ¥
          - [ä½¿ç”¨æ–‡æ¡£](https://github.com/jiangbkvir/jinianbi/blob/main/README.md)
          - [é—®é¢˜åé¦ˆ](https://github.com/jiangbkvir/jinianbi/issues)

          ---

          ðŸ¤– æ­¤ç‰ˆæœ¬å·²è‡ªåŠ¨åŒæ­¥åˆ° [Greasy Fork](https://greasyfork.org/zh-CN/scripts/521357)
          EOF

          echo "Release Notes å·²ç”Ÿæˆ"

      - name: åˆ›å»º GitHub Release
        if: steps.check-version.outputs.should_sync == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.check-version.outputs.version }}
          name: Release v${{ steps.check-version.outputs.version }}
          body_path: release-notes.md
          files: |
            çºªå¿µå¸é¢„çº¦è¾…åŠ©å·¥å…·.user.js
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åŒæ­¥å¤±è´¥æç¤º
        if: steps.check-version.outputs.should_sync == 'false'
        run: |
          echo "=========================================="
          echo "â„¹ï¸ è„šæœ¬æ–‡ä»¶å·²ä¿®æ”¹ï¼Œä½†ç‰ˆæœ¬å·æœªæ›´æ–°"
          echo "å½“å‰ç‰ˆæœ¬æœªå˜åŒ–ï¼Œæœªè§¦å‘ Greasy Fork åŒæ­¥"
          echo "=========================================="
